# 部署前检查清单

本文档汇总部署 A股自选股智能分析系统时**需要根据环境调整**的配置与注意事项。

---

## 一、必须调整的配置

### 1. 环境变量（.env）

部署前务必在**项目根目录**执行：

```bash
cp .env.example .env
# 然后编辑 .env，至少完成以下项
```

| 配置项 | 说明 | 部署建议 |
|--------|------|----------|
| `STOCK_LIST` | 自选股代码，逗号分隔 | 按实盘/回测需求填写，如 `600519,300750,002594` |
| `GEMINI_API_KEY` 或 `OPENAI_API_KEY` 等 | AI 模型至少配置一种 | 必填，否则无法生成分析报告 |
| `TUSHARE_TOKEN` | Tushare Pro（可选） | 有则填，可提升数据质量 |
| `REPORT_TYPE` | 报告类型 | **Docker/云端建议设为 `full`**，避免推送内容不完整 |
| `WEBUI_HOST` | Web/API 监听地址 | **Docker/服务器部署必须为 `0.0.0.0`**（已在 docker-compose 中覆盖） |
| `API_PORT` / `WEBUI_PORT` | 端口 | 默认 `8000`，与宿主机映射一致即可 |

通知渠道（企业微信/飞书/Telegram/Discord/邮件等）按需配置，不配置则不会推送。

### 2. 云端/服务器部署时的建议关闭项

在 `.env` 中可添加或修改（文档见 `.env.example`）：

```ini
# 筹码分布接口不稳定，云端部署建议关闭
ENABLE_CHIP_DISTRIBUTION=false
```

说明见 `src/config.py` 注释：「该接口不稳定，云端部署建议关闭」。

### 3. 反向代理（Nginx / Cloudflare 等）部署

若前面有反向代理，需在 `.env` 中设置：

```ini
TRUST_X_FORWARDED_FOR=true
```

以便从 `X-Forwarded-For` 获取真实 IP（限流、日志等）。直连公网时保持 `false` 防伪造。

### 4. 运行目录与 Docker 路径

- **Docker Compose**：必须在**项目根目录**（包含 `docker/`、`api/`、`main.py` 的目录）执行，例如：

  ```bash
  cd /path/to/daily_stock_analysis-main   # 内层项目根，不是外层解压目录
  docker-compose -f ./docker/docker-compose.yml up -d server
  ```

- 若你是从 ZIP 解压得到**两层** `daily_stock_analysis-main`，请进入**内层**再执行上述命令，否则 build context 会错误，镜像构建会失败。

---

## 二、Docker 相关调整

### 1. docker-compose.yml 路径

- 所有文档中的命令均使用：  
  `docker-compose -f ./docker/docker-compose.yml`
- 构建上下文为项目根（`context: ..` 表示相对 `docker/` 的上一级）。

### 2. 服务模式与端口

| 需求 | 命令 | 说明 |
|------|------|------|
| 仅 Web/API | `docker-compose -f ./docker/docker-compose.yml up -d server` | 推荐，端口 8000 |
| 仅定时任务 | `docker-compose -f ./docker/docker-compose.yml up -d analyzer` | 不暴露端口 |
| 两者都要 | `docker-compose -f ./docker/docker-compose.yml up -d` | server + analyzer |

端口由 `.env` 的 `API_PORT`（默认 8000）决定，compose 中已使用 `${API_PORT:-8000}`。

### 3. 资源与代理（按需）

- **内存**：`docker/docker-compose.yml` 中默认限制 512M、保留 256M，若构建或运行 OOM 可适当调大 `deploy.resources.limits.memory`。
- **代理**：如需走代理，在 compose 的 `environment` 中取消注释并填写：
  ```yaml
  # - http_proxy=http://host.docker.internal:10809
  # - https_proxy=http://host.docker.internal:10809
  ```

### 4. 数据持久化

以下目录已通过 volume 挂载，无需改即可持久化：

- `./data` → 数据库
- `./logs` → 日志
- `./reports` → 报告

确保在项目根目录执行 compose，否则 `../data` 等路径会相对错位。

---

## 三、其他部署方式简要对照

| 方式 | 关键点 |
|------|--------|
| **Zeabur** | 见 `docs/docker/zeabur-deployment.md`，Dockerfile 路径填 `docker/Dockerfile`，启动命令选 `--serve-only` 或 `--schedule` |
| **GitHub Actions** | 见 `docs/DEPLOY.md` 方案四，需配置仓库 Secrets（如 API Key），无服务器 |
| **直接部署（无 Docker）** | 安装 Python 3.10+、依赖、wkhtmltopdf，`cp .env.example .env` 后配置，再 `python main.py --serve-only` 或 `--schedule` |

---

## 四、CI/工作流中的路径说明

- **Docker 构建**：GitHub Actions 与文档一致，使用 `context: .`、`file: docker/Dockerfile`（在仓库根执行）。
- **PR 审查**：`.github/workflows/pr-review.yml` 中触发路径包含 `docker-compose.yml`；实际 compose 文件在 `docker/docker-compose.yml`。若仓库根没有 `docker-compose.yml`，可考虑在 paths 中改为 `docker/docker-compose.yml`，以便修改 compose 时也能触发审查（可选）。

---

## 五、部署后快速自检

1. **Web/API**：`http://<主机>:8000/api/health` 或 `http://<主机>:8000/health` 返回正常。
2. **日志**：`docker-compose -f ./docker/docker-compose.yml logs -f server` 无报错。
3. **定时任务**：若启用 `--schedule`，确认 `.env` 中 `SCHEDULE_ENABLED`、`SCHEDULE_TIME` 等符合预期。

更详细的步骤见：

- 通用部署：`docs/DEPLOY.md`
- 完整配置：`docs/full-guide.md`
- Zeabur：`docs/docker/zeabur-deployment.md`
